# Koda â€” Docker Compose (Production)
#
# Runs the full Koda stack: Next.js app + sandbox network.
# The app creates sandbox containers on-demand via the Docker socket.
#
# Usage:
#   docker compose up -d        # Start
#   docker compose logs -f app  # View logs
#   docker compose down         # Stop
#
# Prerequisites:
#   1. Copy .env.example to .env and add your API keys
#   2. Build sandbox image: docker build -t koda/remotion-sandbox ./templates/remotion-sandbox

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-3000}:3000"
    env_file: .env
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_STORAGE_BACKEND=sqlite
      - SQLITE_PATH=/app/data/koda.db
      - ASSET_STORAGE=local
      - ASSET_LOCAL_PATH=/app/data/generations
    volumes:
      # Persist data across container restarts
      - koda-data:/app/data
      # Mount Docker socket so the app can create sandbox containers
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - koda-sandbox-net
    restart: unless-stopped

networks:
  koda-sandbox-net:
    name: koda-sandbox-net
    driver: bridge

volumes:
  koda-data:
